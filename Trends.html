<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brickonaut · Trends</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#0b2240; --ink:#eaf0f7; --muted:#b8c7dc; --plate:#0f2a50; --stroke:rgba(255,255,255,.10);
    --lego-red:#e11d25; --lego-yellow:#f8c414; --lego-blue:#1e90ff; --lego-green:#31b553;
    --max:1120px; --radius:16px;
  }
  *{box-sizing:border-box; margin:0; padding:0}
  html,body{height:100%}
  body{
    line-height:1.65; color:var(--ink);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Arial, Helvetica, sans-serif;
    background:
      radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.35) 25%, transparent 26%) 0 0/110px 110px,
      radial-gradient(1px 1px at 75% 65%, rgba(255,255,255,.25) 25%, transparent 26%) 0 0/90px 90px,
      linear-gradient(180deg, #0b1d39 0%, var(--bg) 60%);
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:var(--max); margin:0 auto; padding:0 28px}
  .header{position:sticky; top:0; z-index:30; background:rgba(10,22,44,.76); backdrop-filter:blur(8px); border-bottom:1px solid var(--stroke)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:22px; flex-wrap:wrap; padding:18px 0}
  .brand{display:flex; align-items:center; gap:14px}
  .brand img{width:60px; height:60px; object-fit:contain; border-radius:50%; border:2px solid var(--stroke)}
  .brand h1{margin:0; font-family:Bungee,Inter; letter-spacing:.6px; font-size:24px; white-space:nowrap}
  .brand small{display:block; color:var(--muted); letter-spacing:.6px; font-size:13px; margin-top:2px}
  .nav{display:flex; gap:12px; flex-wrap:wrap}
  .cta{display:inline-flex; align-items:center; gap:8px; background:var(--lego-yellow); color:#1b1200; font-weight:800;
       border:none; border-radius:12px; padding:10px 16px; text-decoration:none; font-size:14px; cursor:pointer; transition:filter .2s}
  .cta:hover{filter:brightness(1.06)}
  
  .stud-strip{height:20px; border-top:1px solid var(--stroke); border-bottom:1px solid var(--stroke);
    background:
      radial-gradient(circle at 14px 10px, rgba(255,255,255,.2) 32%, rgba(0,0,0,.3) 33%, transparent 34%) 0 0/52px 20px,
      radial-gradient(circle at 38px 10px, rgba(255,255,255,.2) 32%, rgba(0,0,0,.3) 33%, transparent 34%) 0 0/52px 20px,
      linear-gradient(90deg, var(--lego-red) 0 25%, var(--lego-yellow) 25% 50%, var(--lego-blue) 50% 75%, var(--lego-green) 75% 100%);
    opacity:.55;
  }
  
  .hero{padding:54px 0 32px; text-align:center}
  .h-head{margin:0 0 16px; font-size:40px; letter-spacing:.6px; line-height:1.2}
  .h-sub{margin:0 auto; color:var(--muted); max-width:820px; font-size:17px}
  
  .persona{padding:40px 0}
  .controls{display:grid; grid-template-columns:360px 1fr; gap:24px; align-items:start}
  @media (max-width:980px){ 
    .controls{grid-template-columns:1fr}
    .h-head{font-size:32px}
  }
  
  .card{background:var(--plate); border:1px solid var(--stroke); border-radius:var(--radius); overflow:hidden}
  .stud-top{height:38px; border-bottom:1px solid var(--stroke);
    background:
      radial-gradient(circle at 22px 18px, rgba(255,255,255,.25) 32%, rgba(0,0,0,.3) 33%, transparent 34%) 0 0/64px 38px,
      radial-gradient(circle at 54px 18px, rgba(255,255,255,.25) 32%, rgba(0,0,0,.3) 33%, transparent 34%) 0 0/64px 38px;
  }
  .stud-top.blue{background-color:#0f56b3}
  .stud-top.yellow{background-color:#d9a50a}
  .stud-top.green{background-color:#1f8c43}
  
  .card-body{padding:24px}
  .card h3{margin:0 0 8px; font-size:20px; letter-spacing:.3px}
  .card p{margin:0 0 16px; color:var(--muted); line-height:1.6}
  .small{font-size:13px; color:var(--muted)}
  
  .division-list{display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:16px}
  .division{background:#0d2548; padding:12px 14px; border-radius:10px; border:1px solid var(--stroke); 
    cursor:pointer; color:var(--ink); text-align:left; transition:all .2s; font-size:14px}
  .division:hover{background:#122b58; border-color:rgba(255,255,255,.2)}
  .division.selected{background:var(--lego-blue); border-color:var(--lego-blue); 
    box-shadow:0 4px 12px rgba(30,144,255,.3); font-weight:600}
  
  .form-row{margin-top:16px; display:flex; gap:8px}
  input[type=text]{flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--stroke); 
    background:rgba(0,0,0,.2); color:var(--ink); font-size:14px}
  input[type=text]:focus{outline:none; border-color:var(--lego-green)}
  input[type=text]::placeholder{color:var(--muted)}
  button.primary{background:var(--lego-green); color:white; border:none; padding:12px 18px; 
    border-radius:10px; cursor:pointer; font-weight:700; font-size:14px; transition:filter .2s}
  button.primary:hover{filter:brightness(1.1)}
  
  #trend-plot{min-height:400px; background:rgba(0,0,0,.15); border-radius:12px; padding:20px}
  .meta{margin-top:12px; padding:10px; background:rgba(0,0,0,.2); border-radius:8px; 
    color:var(--muted); font-size:13px; line-height:1.6}
  .meta strong{color:var(--ink)}
  
  .footer{border-top:1px solid var(--stroke); color:var(--muted); text-align:center; padding:32px 0 40px; margin-top:60px}
  
  @media (max-width:640px){ 
    .h-head{font-size:28px}
    .brand h1{font-size:20px}
  }
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img src="assets/lego-logo.png" alt="Brickonaut badge" />
          <div>
            <h1>Brickonaut</h1>
            <small>UIC Chicago · NASA Space Apps · Space Bioscience Explorer</small>
          </div>
        </div>
        <nav class="nav">
          <a class="cta" style="background:var(--lego-blue); color:white" href="scientist.html">Scientist</a>
          <a class="cta" style="background:var(--lego-green); color:white" href="manager.html">Manager</a>
          <a class="cta" style="background:var(--lego-red); color:white" href="architect.html">Architect</a>
          <a class="cta" style="background:var(--lego-yellow)" href="index.html">Home</a>
        </nav>
      </div>
    </div>
    <div class="stud-strip"></div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h2 class="h-head">Trends & Gap Analysis</h2>
      <p class="h-sub">Yearly publication counts and coverage matrices across NASA divisions. Select divisions and keywords to explore research trends over time.</p>
    </section>

    <section class="persona">
      <div class="controls">
        <div class="card">
          <div class="stud-top blue"></div>
          <div class="card-body">
            <h3>Filters</h3>
            <p class="small">Select one or more divisions to filter data. Add keywords to highlight specific research areas.</p>

            <div class="division-list" id="divisionList">
              <div class="division" data-division="Space Biology">Space Biology</div>
              <div class="division" data-division="Human Research">Human Research</div>
              <div class="division" data-division="Physical Sciences">Physical Sciences</div>
              <div class="division" data-division="Human Research, Space Biology">Human Research + Space Biology</div>
              <div class="division" data-division="Physical Sciences, Space Biology">Physical Sciences + Space Biology</div>
            </div>

            <div class="form-row">
              <input id="keyword" type="text" placeholder="Enter keywords (e.g., bone, muscle)" />
              <button id="updateBtn" class="primary">Update</button>
            </div>

            <div class="meta">
              <strong>Selected:</strong> <span id="selectedDivision">None</span><br>
              <strong>Keywords:</strong> <span id="selectedKeyword">—</span>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="stud-top yellow"></div>
            <div class="card-body">
              <h3>Publication Trends</h3>
              <p class="small">Interactive timeline showing publication counts by year. Click data points for details.</p>
              <div id="trend-plot">
                <div id="plot-placeholder" class="small" style="padding:60px 20px; text-align:center;">
                  Select a division and click "Update" to view trends
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap"><small>© 2025 Brickonaut · Le'Go Team · UIC Chicago · NASA Space Apps</small></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const selectedDivisions = new Set();
    const divisionList = document.getElementById('divisionList');
    const keywordInput = document.getElementById('keyword');
    const updateBtn = document.getElementById('updateBtn');
    const selDivEl = document.getElementById('selectedDivision');
    const selKeyEl = document.getElementById('selectedKeyword');

    function updateSelectedUI(){
      if(selectedDivisions.size === 0){
        selDivEl.textContent = 'None';
      } else {
        selDivEl.textContent = Array.from(selectedDivisions).join(', ');
      }
    }

    divisionList.addEventListener('click', e => {
      const el = e.target.closest('.division');
      if(!el) return;
      const key = el.dataset.division;
      const nowSelected = el.classList.toggle('selected');
      if(nowSelected) selectedDivisions.add(key);
      else selectedDivisions.delete(key);
      updateSelectedUI();
    });

    updateBtn.addEventListener('click', async () => {
      const keyword = keywordInput.value.trim();
      selKeyEl.textContent = keyword || '—';
      const divisions = Array.from(selectedDivisions);
      
      if(divisions.length === 0){
        alert('Please select at least one division');
        return;
      }
      
      await renderPlot({divisions, keyword});
    });

    keywordInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') updateBtn.click();
    });

    async function renderPlot(opts){
      const plotArea = document.getElementById('trend-plot');
      const placeholder = document.getElementById('plot-placeholder');
      
      if(placeholder) placeholder.textContent = 'Loading data...';

      try {
        console.log('Fetching with options:', opts);
        const res = await fetch('/api/trends', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(opts)
        });

        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(`Server returned ${res.status}: ${errorText}`);
        }

        const data = await res.json();
        console.log('Received data:', data);

        if(!data.years || !data.series || data.series.length === 0){
          plotArea.innerHTML = '<div class="small" style="padding:60px 20px; text-align:center;">No data found for the selected filters</div>';
          return;
        }

        // Clear and create canvas
        plotArea.innerHTML = '';
        const canvas = document.createElement('canvas');
        plotArea.appendChild(canvas);

        // Destroy previous chart
        if(window._brickonautChart) window._brickonautChart.destroy();

        const palette = [
          'rgba(30,144,255,0.9)', 'rgba(49,181,83,0.9)', 'rgba(225,29,37,0.9)', 
          'rgba(248,196,20,0.9)', 'rgba(128,0,128,0.9)', 'rgba(255,140,0,0.9)'
        ];

        const datasets = data.series.map((s, i) => ({
          label: `${s.name} (${s.total || 0} total)`,
          data: s.counts || [],
          borderColor: palette[i % palette.length],
          backgroundColor: palette[i % palette.length].replace('0.9', '0.15'),
          fill: true,
          tension: 0.2,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 2
        }));

        const ctx = canvas.getContext('2d');
        window._brickonautChart = new Chart(ctx, {
          type: 'line',
          data: { labels: data.years, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: { 
              legend: { 
                display: true,
                labels: { color: '#eaf0f7', font: { size: 12 } }
              },
              tooltip: { 
                mode: 'index', 
                intersect: false,
                backgroundColor: 'rgba(11,34,64,0.95)',
                titleColor: '#eaf0f7',
                bodyColor: '#b8c7dc'
              }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false },
            scales: { 
              x: { 
                title: { display: true, text: 'Fiscal Year', color: '#eaf0f7' },
                ticks: { color: '#b8c7dc' },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              y: { 
                title: { display: true, text: 'Publication Count', color: '#eaf0f7' },
                beginAtZero: true,
                ticks: { color: '#b8c7dc' },
                grid: { color: 'rgba(255,255,255,0.05)' }
              }
            }
          }
        });

      } catch(err){
        console.error('Plot error:', err);
        plotArea.innerHTML = `<div class="small" style="padding:60px 20px; text-align:center; color:#e11d25;">
          Error loading plot: ${err.message}<br><br>
          Check browser console (F12) for details
        </div>`;
      }
    }

    updateSelectedUI();
  </script>
</body>
</html>